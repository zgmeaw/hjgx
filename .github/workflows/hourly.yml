name: Hourly Update
on:
  workflow_dispatch:      # 允许手动点击运行
  schedule:
    # 每两小时运行一次，排除晚上12点到早上8点（北京时间）
    # 北京时间 8, 10, 12, 14, 16, 18, 20, 22 点 = UTC 0, 2, 4, 6, 8, 10, 12, 14 点
    - cron: '0 0,2,4,6,8,10,12,14 * * *'   # 每两小时一次（排除晚上12点到早上8点）

permissions:
  contents: write         # 赋予写权限以便提交代码

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install
          # 关键：显式安装 Puppeteer 对应的 Chrome
          npx puppeteer browsers install chrome

      - name: Run update script
        run: node scripts/update.js
        env:
          # 告诉 Puppeteer 使用刚才下载的 Chrome
          PUPPETEER_CACHE_DIR: /home/runner/.cache/puppeteer
          # 从 GitHub Secrets 读取博主链接（每行一个链接）
          BLOGGER_LINKS: ${{ secrets.BLOGGER_LINKS }}
          # Google 搜索域名（必需，未设置时搜索按钮将不可用）
          GOOGLE_SEARCH_DOMAIN: ${{ secrets.GOOGLE_SEARCH_DOMAIN }}
          # 数据加密密钥（必需，用于加密A、B记录）
          DATA_ENCRYPT_KEY: ${{ secrets.DATA_ENCRYPT_KEY }}
          # 网页密码（必需，用于网页访问保护）
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}

      # 如果脚本生成了 debug 图片，上传以便查看
      - name: Upload Debug Artifacts
        if: always() # 即使脚本报错也执行
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: |
            *.jpg
            *.html
          retention-days: 3

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "action@github.com"
          # 提交 index.html 和 data 文件夹
          git add index.html
          git add data/
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update $(date)" && git push)